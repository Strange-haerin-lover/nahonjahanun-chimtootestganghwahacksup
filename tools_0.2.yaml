tool: nmap
version: "0.2"

types:
  ip_target:
    desc: "IP/도메인 또는 CIDR"
    validate:
      regex: "^(?:[a-zA-Z0-9.-]+|(?:\\d{1,3}\\.){3}\\d{1,3}(?:/\\d{1,2})?)$"
  ip_targets:
    desc: "공백으로 구분된 다중 타겟"
    validate:
      regex: "^(.+)$"
  port:
    desc: "단일 포트"
    validate:
      range: [1, 65535]
  port_list:
    desc: "쉼표 구분 포트 리스트"
    validate:
      regex: "^(\\d{1,5})(,\\d{1,5})*$"
  top_n:
    desc: "상위 포트 개수"
    validate:
      range: [1, 10000]
  timing:
    desc: "스캔 속도 프로파일"
    enum: ["T0","T1","T2","T3","T4","T5"]
  bool:
    enum: [true, false]
  rate:
    desc: "초당 최대 패킷 수"
    validate:
      range: [1, 100000]
  retry_count:
    desc: "재시도 최대 횟수"
    validate:
      range: [0, 20]

globals:
  default_timing: "T3"
  output_dir: "./scan_out"

actions:

  - name: host_discovery
    desc: "핑 스윕(호스트 생존 확인)"
    command_template: >
      nmap -sn {{targets}} -{{timing|default:{{globals.default_timing}}}}
      {{#save}}-oA {{globals.output_dir}}/{{out_prefix}}{{/save}}
    action_space:
      targets:    {type: ip_targets, required: true}
      timing:     {type: timing,    required: false}
      save:       {type: bool,      required: false, default: false}
      out_prefix: {type: ip_target, required: false, default: "scan"}
    validation: {}

  - name: tcp_syn_top
    desc: "TCP SYN 상위 N 포트"
    command_template: >
      nmap -sS --top-ports {{top_n}} {{targets}} -{{timing|default:{{globals.default_timing}}}}
      {{#no_ping}}-Pn{{/no_ping}} {{#save}}-oA {{globals.output_dir}}/{{out_prefix}}{{/save}}
    action_space:
      targets:    {type: ip_targets, required: true}
      top_n:      {type: top_n,     required: true}
      timing:     {type: timing,    required: false}
      no_ping:    {type: bool,      required: false, default: false}
      save:       {type: bool,      required: false, default: true}
      out_prefix: {type: ip_target, required: false, default: "tcp_syn_top"}
    validation: {}

  - name: tcp_connect_list
    desc: "TCP Connect 지정 포트"
    command_template: >
      nmap -sT -p {{ports}} {{targets}} -{{timing|default:{{globals.default_timing}}}}
      {{#save}}-oA {{globals.output_dir}}/{{out_prefix}}{{/save}}
    action_space:
      targets:    {type: ip_targets, required: true}
      ports:      {type: port_list,  required: true}
      timing:     {type: timing,     required: false}
      save:       {type: bool,       required: false, default: true}
      out_prefix: {type: ip_target,  required: false, default: "tcp_connect_list"}
    validation: {}

  - name: udp_top
    desc: "UDP 상위 N 포트"
    command_template: >
      nmap -sU --top-ports {{top_n}} {{targets}} -{{timing|default:{{globals.default_timing}}}}
      {{#no_ping}}-Pn{{/no_ping}} {{#save}}-oA {{globals.output_dir}}/{{out_prefix}}{{/save}}
    action_space:
      targets:    {type: ip_targets, required: true}
      top_n:      {type: top_n,     required: true}
      timing:     {type: timing,    required: false}
      no_ping:    {type: bool,      required: false, default: true}
      save:       {type: bool,      required: false, default: true}
      out_prefix: {type: ip_target, required: false, default: "udp_top"}
    validation: {}

  - name: service_version
    desc: "서비스 버전 식별"
    command_template: >
      nmap -sS -sV -p {{ports}} {{targets}} -{{timing|default:{{globals.default_timing}}}}
      {{#save}}-oA {{globals.output_dir}}/{{out_prefix}}{{/save}}
    action_space:
      targets:    {type: ip_targets, required: true}
      ports:      {type: port_list,  required: true}
      timing:     {type: timing,     required: false}
      save:       {type: bool,       required: false, default: true}
      out_prefix: {type: ip_target,  required: false, default: "service_version"}
    validation: {}

  - name: os_detect
    desc: "OS 식별(권한 필요할 수 있음)"
    command_template: >
      nmap -O {{targets}} -{{timing|default:{{globals.default_timing}}}}
      {{#save}}-oA {{globals.output_dir}}/{{out_prefix}}{{/save}}
    action_space:
      targets:    {type: ip_targets, required: true}
      timing:     {type: timing,     required: false}
      save:       {type: bool,       required: false, default: true}
      out_prefix: {type: ip_target,  required: false, default: "os_detect"}
    validation: {}

  - name: script_vuln
    desc: "NSE vuln 스크립트 실행(+버전 스캔)"
    command_template: >
      nmap -sS -sV --script vuln -p {{ports}} {{targets}} -{{timing|default:{{globals.default_timing}}}}
      {{#save}}-oA {{globals.output_dir}}/{{out_prefix}}{{/save}}
    action_space:
      targets:    {type: ip_targets, required: true}
      ports:      {type: port_list,  required: true}
      timing:     {type: timing,     required: false}
      save:       {type: bool,       required: false, default: true}
      out_prefix: {type: ip_target,  required: false, default: "vuln_scan"}
    validation: {}

  - name: aggressive_profile
    desc: "공격적 프로파일(-A: OS/버전/스크립트/트레이스)"
    command_template: >
      nmap -A --top-ports {{top_n}} {{targets}} -{{timing|default:T4}}
      {{#no_ping}}-Pn{{/no_ping}} {{#save}}-oA {{globals.output_dir}}/{{out_prefix}}{{/save}}
    action_space:
      targets:    {type: ip_targets, required: true}
      top_n:      {type: top_n,     required: true}
      timing:     {type: timing,    required: false}
      no_ping:    {type: bool,      required: false, default: true}
      save:       {type: bool,      required: false, default: true}
      out_prefix: {type: ip_target, required: false, default: "aggr"}
    validation: {}

  - name: banner_grab
    desc: "배너 수집(안전 NSE)"
    command_template: >
      nmap -sT -Pn --script banner -p {{ports}} {{targets}} -{{timing|default:{{globals.default_timing}}}}
      {{#save}}-oA {{globals.output_dir}}/{{out_prefix}}{{/save}}
    action_space:
      targets:    {type: ip_targets, required: true}
      ports:      {type: port_list,  required: true}
      timing:     {type: timing,     required: false}
      save:       {type: bool,       required: false, default: true}
      out_prefix: {type: ip_target,  required: false, default: "banner"}
    validation: {}

  - name: timing_tune
    desc: "타이밍·재시도/속도 미세조정"
    command_template: >
      nmap -sS --top-ports {{top_n}} {{targets}} -{{timing|default:{{globals.default_timing}}}}
      {{#max_rate}}--min-rate {{max_rate}}{{/max_rate}}
      {{#retries}}--max-retries {{retries}}{{/retries}}
      {{#host_timeout}}--host-timeout {{host_timeout}}s{{/host_timeout}}
      {{#save}}-oA {{globals.output_dir}}/{{out_prefix}}{{/save}}
    action_space:
      targets:     {type: ip_targets,  required: true}
      top_n:       {type: top_n,       required: true}
      timing:      {type: timing,      required: false}
      max_rate:    {type: rate,        required: false}
      retries:     {type: retry_count, required: false}
      host_timeout:
        desc: "호스트 타임아웃(초)"
        validate: {range: [1, 3600]}
      save:        {type: bool,        required: false, default: true}
      out_prefix:  {type: ip_target,   required: false, default: "timing"}
    validation: {}
